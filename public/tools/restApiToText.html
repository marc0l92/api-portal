<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <title>REST Api to Text</title>
</head>

<body class="api-style">
    <nav class="navbar">
        <div class="navbar-brand">
            <a class="navbar-item" href="https://marc0l92.github.io/api-tools/"><strong>API Tools</strong></a>

            <a role="button" class="navbar-burger" data-target="my-navbar">
                <span></span>
                <span></span>
                <span></span>
            </a>
        </div>

        <div id="my-navbar" class="navbar-menu">
            <div class="navbar-start">
                <a class="navbar-item is-active">REST Api to Text</a>
                <a class="navbar-item">API to Spreadsheet</a>
            </div>

            <div class="navbar-end">
                <div class="navbar-item">
                    <div class="buttons">
                        <a class="button is-primary"
                            href="https://github.com/marc0l92/api-tools/issues/new/choose"><strong>Feedbacks</strong></a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <div class="container">
        <section class="hero is-small">
            <div class="hero-body">
                <h1 class="title">REST Api to Text</h1>
                <p class="subtitle">Input your api <i>method</i> and <i>URI</i> and check what is the meaning of it
                    according to
                    the REST API guidelines</p>
            </div>
        </section>
        <div class="box">
            <form>
                <div class="columns">
                    <div class="column">
                        <div class="field has-addons">
                            <div class="control">
                                <div class="select">
                                    <select id="method">
                                        <option value="GET">GET</option>
                                        <option value="POST">POST</option>
                                        <option value="PUT">PUT</option>
                                        <option value="PATCH">PATCH</option>
                                        <option value="DELETE">DELETE</option>
                                    </select>
                                </div>
                            </div>
                            <div class="control is-expanded">
                                <input type="text" class="input" id="uri"
                                    placeholder="/v1/reservation/chains/AAA/links/1234567890"
                                    value="/v1/reservation/chains/AAA/links/1234567890" />
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="box">
            <p class="subtitle"><strong>Parsing output:</strong></p>
            <div id="response">
                <div class="field has-addons">
                    <p class="control">
                        <input class="checkbox" type="checkbox" checked>
                    </p>
                    <p class="control"><a class="button is-static" id="version"></a></p>
                </div>
                <!-- <span class="badge bg-success" id="version"></span> -->
                <span class="badge bg-primary" id="capability"></span>
                <p id="text">Javascript loading...</p>
                <div id="textAlternativeSection" style="display: none;">
                    <p>-- or --</p>
                    <p id="textAlternative">Javascript loading...</p>
                </div>
            </div>
        </div>
        <div class="alert alert-danger" id="errors" style="display: none;"></div>
    </div>
    <script src="../js/pluralize.js"></script>
    <script>
        window.onload = () => {
            const $method = document.getElementById('method')
            const $uri = document.getElementById('uri')
            const $response = document.getElementById('response')
            const $version = document.getElementById('version')
            const $capability = document.getElementById('capability')
            const $text = document.getElementById('text')
            const $textAlternative = document.getElementById('textAlternative')
            const $textAlternativeSection = document.getElementById('textAlternativeSection')
            const $errors = document.getElementById('errors')

            const UriNotCompleted = 'Error: Uri not completed, continue typing...'
            const methodsVerb = {
                resource: {
                    GET: (resourceId, collectionName) => 'Retrieve the ' + pluralize.singular(collectionName) + ' with id ' + resourceId,
                    POST: (controllerName, collectionName) => 'Perform the action of "' + controllerName + '" on the ' + collectionName,
                    PUT: (resourceId, collectionName) => 'Replace with the one in request the ' + pluralize.singular(collectionName) + ' with id ' + resourceId,
                    PATCH: (resourceId, collectionName) => 'Apply the changes listed in request to the ' + pluralize.singular(collectionName) + ' with id ' + resourceId,
                    DELETE: (resourceId, collectionName) => 'Delete the ' + pluralize.singular(collectionName) + ' with id ' + resourceId,
                },
                collection: {
                    GET: (collectionName) => 'Search in the ' + collectionName,
                    POST: (collectionName) => 'Create a new ' + pluralize.singular(collectionName),
                    PUT: (collectionName) => 'Replace with the list in request all the ' + collectionName,
                    PATCH: (collectionName) => 'Replace with the list in request all the ' + collectionName,
                    DELETE: (collectionName) => 'Delete all the ' + collectionName,
                    CONTROLLER: (controllerName, resourceId, collectionName) => 'Perform the action of "' + controllerName + '" on the ' + pluralize.singular(collectionName) + ' with id ' + resourceId,
                },
            }

            const resetUiComponents = () => {
                $version.innerHTML = ''
                $capability.innerHTML = ''
                $text.innerHTML = ''
                $textAlternative.innerHTML = ''
                $errors.innerHTML = ''

                $errors.style.display = 'none'
                $response.style.display = 'none'
                $textAlternativeSection.style.display = 'none'
            }

            const updateText = (e) => {
                resetUiComponents()

                let uriParts = $uri.value.split('/')
                let uriPartsAlternative = []
                for (i in uriParts) {
                    if (uriParts[i] === '') {
                        uriParts.splice(i, 1)
                    }
                }
                if (uriParts.length >= 3) {
                    $response.style.display = 'block'
                    $version.innerHTML = 'Version: ' + uriParts.splice(0, 1)[0].slice(1)
                    $capability.innerHTML = 'Capability: ' + uriParts.splice(0, 1)
                    $text.innerHTML = ''
                    $textAlternative.innerHTML = ''
                    uriParts = uriParts.reverse()

                    if (uriParts.length % 2 === 0) {
                        // Resource or controller
                        $text.innerHTML += methodsVerb.resource[$method.value](uriParts[0], uriParts[1])
                        uriParts.splice(0, 2)
                    } else {
                        // Collection
                        $text.innerHTML += methodsVerb.collection[$method.value](uriParts[0])
                        if ($method.value === 'POST') {
                            uriPartsAlternative = uriParts.slice()
                            $textAlternative.innerHTML += methodsVerb.collection['CONTROLLER'](uriPartsAlternative[0], uriPartsAlternative[1], uriPartsAlternative[2])
                            $textAlternativeSection.style.display = 'block'
                            uriPartsAlternative.splice(0, 3)
                        }
                        uriParts.splice(0, 1)
                    }

                    while (uriParts.length > 0) {
                        const collectionName = uriParts[1]
                        const resourceId = uriParts[0]
                        $text.innerHTML += ' of the ' + pluralize.singular(collectionName) + ' with id ' + resourceId
                        uriParts.splice(0, 2)
                    }
                    while (uriPartsAlternative.length > 0) {
                        const collectionName = uriPartsAlternative[1]
                        const resourceId = uriPartsAlternative[0]
                        $textAlternative.innerHTML += ' of the ' + pluralize.singular(collectionName) + ' with id ' + resourceId
                        uriPartsAlternative.splice(0, 2)
                    }

                    // Rewrite query parameters
                    var urlParams = new URLSearchParams(window.location.search);
                    urlParams.set('method', $method.value)
                    urlParams.set('uri', $uri.value)
                    window.history.pushState(null, null, '?' + urlParams.toString());
                } else {
                    console.log(UriNotCompleted)
                    $errors.innerHTML = UriNotCompleted
                    $errors.style.display = 'block'
                }
            }

            $method.onchange = updateText
            $uri.oninput = updateText

            // Check query parameter
            let urlParams = new URLSearchParams(window.location.search)
            if (urlParams.has('method')) {
                $method.value = urlParams.get('method')
            }
            if (urlParams.has('uri')) {
                $uri.value = urlParams.get('uri')
            }

            updateText()
        }
    </script>
    <script>
        // Hot reload
        new EventSource('/esbuild').addEventListener('change', () => location.reload())
    </script>
</body>

</html>